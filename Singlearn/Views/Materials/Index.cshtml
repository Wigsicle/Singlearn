@model IEnumerable<Singlearn.Models.Entities.Material>

@{
    ViewData["Title"] = "Materials List";
    var materials = Model.Select(m => m.name).Distinct().OrderBy(material => material).ToList();
    var types = Model.Select(m => m.type).Distinct().OrderBy(type => type).ToList();
    var statuses = Model.Select(m => m.status).Distinct().OrderBy(status => status).ToList();
}
<body>
    <div style="padding:8% 3% 3% 3%;">
        <div class="row">
            <!-- Filter Panel: Side Panel -->
            <div class="mt-3 col-lg-2">
                <div class="form-group pt-3 pb-3">
                    <button class="btn btn-secondary" id="clearFiltersBtn">Clear Filters</button>
                </div>
                <!-- Material name -->
                <div class="card mb-2">
                    <div class="card-body">
                        <h5 class="card-title">Material</h5>
                        @foreach (var material in materials)
                        {
                            <div class="form-check">
                                <input class="form-check-input material-filter" type="checkbox" value="@material" id="@material">
                                <label class="form-check-label" for="@material">
                                    @material
                                </label>
                            </div>
                        }
                    </div>
                </div>

                <!-- Type -->
                <div class="card mb-2">
                    <div class="card-body">
                        <h5 class="card-title">Type</h5>
                        @foreach (var type in types)
                        {
                            <div class="form-check">
                                <input class="form-check-input type-filter" type="checkbox" value="@type" id="@type">
                                <label class="form-check-label" for="@type">
                                    @type
                                </label>
                            </div>
                        }
                    </div>
                </div>

                <!-- Year -->
                <div class="card mb-2">
                    <div class="card-body">
                        <h5 class="card-title">Status</h5>
                        @foreach (var status in statuses)
                        {
                            <div class="form-check">
                                <input class="form-check-input status-filter" type="checkbox" value="@status" id="@status">
                                <label class="form-check-label" for="@status">
                                    @status
                                </label>
                            </div>
                        }
                    </div>
                </div>
            </div>
            <!-- End of Filter Panel -->

            <!-- Main Content: Table and Pagination -->
            <div class="col-lg-10 pt-3">
                <h1>List of Materials</h1>

                <!--Alert box-->
                <div id="alert-message" class="alert alert-dismissible fade show mt-3 mb-3" role="alert" style="display:none;">
                    <span id="alert-text"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <!--Search Box-->
                <div class="form-group pt-3 pb-3">
                    <input type="text" class="form-control" id="searchInput" placeholder="Search for materials...">
                </div>

                <!--Create button-->
                <a asp-action="Create" class="btn btn-primary mb-3">Create Material</a>

                <!--Table-->
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="materialsTable">
                        <thead class="thead-dark">
                            <tr>
                                <th>Material Name</th>
                                <th>Description</th>
                                <th>Subject</th>
                                <th>Staff</th>
                                <th>Class</th>
                                <th>Chapter</th>
                                <th>Type</th>
                                <th>Link</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>@Html.DisplayFor(modelItem => item.name)</td>
                                    <td>@Html.DisplayFor(modelItem => item.description)</td>
                                    <td>@Html.DisplayFor(modelItem => item.subject_id)</td>
                                    <td>@Html.DisplayFor(modelItem => item.teacher_id)</td>
                                    <td>@Html.DisplayFor(modelItem => item.class_id)</td>
                                    <td>@Html.DisplayFor(modelItem => item.chapter_id)</td>
                                    <td>@Html.DisplayFor(modelItem => item.type)</td>
                                    <td>@Html.DisplayFor(modelItem => item.link)</td>
                                    <td>@Html.DisplayFor(modelItem => item.status)</td>
                                    <td>
                                        <a asp-action="Details" asp-route-id="@item.material_id"><i class="fa fa-eye text-primary"></i></a> |
                                        <a asp-action="Edit" asp-route-id="@item.material_id"><i class="fa fa-pencil text-warning"></i></a> |
                                        <a asp-action="Delete" asp-route-id="@item.material_id"><i class="fa fa-trash text-danger"></i></a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <!-- End of table -->

                <!-- Pagination -->
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center" id="pagination">
                        <li class="page-item" id="previousPage">
                            <a class="page-link" href="" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                                <span class="sr-only">Previous</span>
                            </a>
                        </li>
                        <!-- Pagination Links will be dynamically added here -->
                        <li class="page-item" id="nextPage">
                            <a class="page-link" href="" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                                <span class="sr-only">Next</span>
                            </a>
                        </li>
                    </ul>
                </nav>
                <!-- End of Pagination -->
            </div>
            <!-- End of Main Content -->
        </div>
    </div>
</body>


@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var materials = @Html.Raw(Json.Serialize(Model));
            var currentPage = 1;
            var rowsPerPage = 10; 
            var successMessage = '@TempData["SuccessMessage"]';
            var errorMessage = '@TempData["ErrorMessage"]';

            if (successMessage) {
                showAlert('success', successMessage);
            } else if (errorMessage) {
                showAlert('danger', errorMessage);
            }

            function showAlert(type, message) {
                var alertBox = document.getElementById('alert-message');
                var alertText = document.getElementById('alert-text');
                alertBox.classList.remove('alert-success', 'alert-danger');
                alertBox.classList.add('alert-' + type);
                alertText.textContent = message;
                alertBox.style.display = 'block';
            }

            function updateTable(page) {
                var startIndex = (page - 1) * rowsPerPage;
                var endIndex = startIndex + rowsPerPage;
                var slicedMaterials = materials.slice(startIndex, endIndex);

                updateTableContent(slicedMaterials);
            }

            function updateTableContent(filteredMaterials) {
                var tableBody = document.querySelector("#materialsTable tbody");
                tableBody.innerHTML = "";

                filteredMaterials.forEach(function (item) {
                    var row = `
                                        <tr>
                                            <td>${item.name}</td>
                                            <td>${item.description}</td>
                                            <td>${item.subject_id}</td>
                                            <td>${item.teacher_id}</td>
                                            <td>${item.class_id}</td>
                                            <td>${item.chapter_id}</td>
                                            <td>${item.type}</td>
                                            <td>${item.link}</td>
                                            <td>${item.status}</td>
                                            <td>
                                                <a href="/Materials/Details/${item.material_id}"><i class="fa fa-eye text-primary"></i></a> |
                                                <a href="/Materials/Edit/${item.material_id}"><i class="fa fa-pencil text-warning"></i></a> |
                                                <a href="/Materials/Delete/${item.material_id}"><i class="fa fa-trash text-danger"></i></a>
                                            </td>
                                        </tr>`;
                    tableBody.innerHTML += row;
                });

                // Update pagination after updating table content
                updatePagination(filteredMaterials.length);
            }

            function updatePagination() {
                var totalPages = Math.ceil(materials.length / rowsPerPage);
                var paginationElement = document.getElementById("pagination");
                paginationElement.innerHTML = "";

                var previousLi = `<li class="page-item" id="previousPage">
                                                    <a class="page-link" href="" aria-label="Previous">
                                                        <span aria-hidden="true">&laquo;</span>
                                                        <span class="sr-only">Previous</span>
                                                    </a>
                                                  </li>`;
                paginationElement.innerHTML += previousLi;

                for (var i = 1; i <= totalPages; i++) {
                    var li = `<li class="page-item"><a class="page-link" href="">${i}</a></li>`;
                    paginationElement.innerHTML += li;
                }

                var nextLi = `<li class="page-item" id="nextPage">
                                                <a class="page-link" href="" aria-label="Next">
                                                    <span aria-hidden="true">&raquo;</span>
                                                    <span class="sr-only">Next</span>
                                                </a>
                                              </li>`;
                paginationElement.innerHTML += nextLi;

                var pageLinks = document.querySelectorAll("#pagination .page-link");

                pageLinks.forEach(function (pageLink, index) {
                    if (index === 0) {
                        pageLink.addEventListener("click", function (event) {
                            event.preventDefault();
                            if (currentPage > 1) {
                                currentPage--;
                                updateTable(currentPage);
                            }
                        });
                    } else if (index === pageLinks.length - 1) {
                        pageLink.addEventListener("click", function (event) {
                            event.preventDefault();
                            if (currentPage < totalPages) {
                                currentPage++;
                                updateTable(currentPage);
                            }
                        });
                    } else {
                        pageLink.addEventListener("click", function (event) {
                            event.preventDefault();
                            currentPage = parseInt(pageLink.textContent);
                            updateTable(currentPage);
                        });
                    }
                });
            }

            function getSelectedValues(className) {
                var checkboxes = document.querySelectorAll(`.${className}:checked`);
                return Array.from(checkboxes).map(cb => cb.value);
            }

            function filterMaterials() {
                var selectedMaterials = getSelectedValues('material-filter');
                var selectedTypes = getSelectedValues('type-filter');
                var selectedStatus = getSelectedValues('status-filter');

                // Check if no checkboxes are selected, then reset filters
                if (selectedMaterials.length === 0 && selectedTypes.length === 0 && selectedStatus.length === 0) {
                    updateTableContent(materials); // Reset to show all materials
                    return;
                }
                var filteredMaterials = materials.filter(function (item) {
                    return (selectedMaterials.length === 0 || selectedMaterials.includes(item.name)) &&
                        (selectedTypes.length === 0 || selectedTypes.includes(item.type)) &&
                        (selectedStatus.length === 0 || selectedStatus.includes(item.status));
                });

                updateTableContent(filteredMaterials);
            }

            var filters = document.querySelectorAll('.form-check-input');
            filters.forEach(function (filter) {
                filter.addEventListener('change', filterMaterials);
            });

            // Search bar functionality
            document.getElementById('searchInput').addEventListener('input', function () {
                var filter = this.value.toLowerCase();
                var rows = document.querySelectorAll("#materialsTable tbody tr");

                rows.forEach(function (row) {
                    var text = row.textContent.toLowerCase();
                    if (text.includes(filter)) {
                        row.style.display = "";
                    } else {
                        row.style.display = "none";
                    }
                });
            });

            // Clear Filters button functionality
            document.getElementById('clearFiltersBtn').addEventListener('click', function () {
                // Uncheck all checkboxes
                document.querySelectorAll('.form-check-input').forEach(function (checkbox) {
                    checkbox.checked = false;
                });

                // Clear search input
                document.getElementById('searchInput').value = '';


                // Reset table and pagination
                currentPage = 1;
                updateTable(currentPage);
                updatePagination();
            });

            // Initial setup
            updateTable(currentPage);
            updatePagination();
        });
    </script>

}
